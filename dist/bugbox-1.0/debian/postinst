#!/bin/bash
# postinst script for bugbox
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
# * <postinst> `configure' <most-recently-configured-version>
# * <old-postinst> `abort-upgrade' <new version>
# * <conflictor's-postinst> `abort-remove' `in-favour' <package>
# <new-version>
# * <postinst> `abort-remove'
# * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
# <failed-install-package> <version> `removing'
# <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

CHROOT_JAILS=(Debian5 Debian7)
BUGBOX_ROOT=/usr/lib/bugbox
RESOURCES=$BUGBOX_ROOT/framework/chroot_envs/build/resources
CHROOT_ROOT=$BUGBOX_ROOT/framework/chroot_envs


case "$1" in
configure)

    for JAIL in ${CHROOT_JAILS[@]}
    do
	$CHROOT_ROOT/build/install_chroot_jail.sh $JAIL
    done

    if [ -e /etc/bash_completion.d ] ; then
	echo "Installing bash completion file"
	cp $RESOURCES/bbcompletion /etc/bash_completion.d
    fi

    echo "Installing selenium service"
    cp $RESOURCES/selenium /etc/init.d
    insserv selenium

    if [[ ! -e /var/run/selenium.pid ]] ; then
	/etc/init.d/selenium start
    fi

    echo "Setting application permissions"
    find $BUGBOX_ROOT/framework/Targets -type d \( -path '*/application' -o -path '*/plugins/*/plugin' \) -exec chown -R www-data:www-data {} \;

    MSF_DIR=$BUGBOX_ROOT/lib/metasploit-framework
    PATCH_FILE=$BUGBOX_ROOT/lib/msf.diff

    echo "Cloning Metasploit repository"
    mkdir $MSF_DIR
    git clone https://github.com/rapid7/metasploit-framework.git $MSF_DIR
    (cd $MSF_DIR && git checkout 40e801d345ecf4ddc233b26c6bc2aac6741556d1)
    (cd $MSF_DIR && patch -f -R -p1 < $PATCH_FILE)

    echo "Configuring MYSQL"
    echo "You will be asked for the root password so that a superuser can be added to the mysql server"
    echo -e "CREATE USER 'dbroot'@'localhost' IDENTIFIED BY 'connection452';\nGRANT ALL PRIVILEGES ON *.* TO 'dbroot'@'localhost' WITH GRANT OPTION;" | mysql -uroot -p 
	
    exit 0
;;

abort-upgrade|abort-remove|abort-deconfigure)
;;

*)
echo "postinst called with unknown argument \`$1'" >&2
exit 1
;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
