var ColorPicker=Class.create();ColorPicker.prototype={initialize:function(a){this.options=Object.extend({color:"ffffff",update:[],draggable:false,resizable:false,offsetParent:null,offset:10},a||{});this.stop=1;this.zIndex=1000;this.hsv=Color.hex2hsv(this.options.color);var d=$("color-picker");if(!d){d=document.createElement("DIV");d.id="color-picker";d.style.display="none";d.innerHTML='<div class="north"><span id="color-picker-hex"></span><div id="color-picker-close">X</div></div><div class="south" id="color-picker-sphere" style="height:128px; width:128px;"><div id="color-picker-cursor"></div><img id="color-picker-palette" src="" onmousedown="return false;" ondrag="return false;" onselectstart="return false;" /><img id="color-picker-resize" src="" ondrag="return false;" onselectstart="return false;" /></div>';document.body.appendChild(d)}d.style.position="absolute";var c;if(this.options.offsetParent){c=Position.cumulativeOffset(this.options.offsetParent)}else{c=[0,0]}d.style.left=c[0]+this.options.offset+"px";d.style.top=c[1]+this.options.offset+"px";d.style.display="";if(!this.iefix&&Prototype.Browser.IE){new Insertion.After("color-picker",'<iframe id="color-picker-iefix" style="display:none;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);" src="javascript:false;" frameborder="0" scrolling="no"></iframe>');this.iefix=$("color-picker-iefix")}if(this.iefix){setTimeout(this.fixIEOverlapping.bind(this),50)}if(this.options.draggable){$("color-picker").style.cursor="move"}$("color-picker-hex").innerHTML=this.options.color;$("color-picker-cursor").style.visibility="hidden";var b=$("color-picker-cursor").getStyle("backgroundImage").replace(/url\("?(.*?)"?\)/,"$1").replace("color-picker-cursor.gif","");$("color-picker-palette").src=b.replace($("color-picker-palette").src,"")+"color-picker-palette.png";if(this.options.resizable){$("color-picker-resize").src=b.replace($("color-picker-palette").src,"")+"color-picker-resize.gif"}else{$("color-picker-resize").hide()}this.addEvents();$("color-picker").show()},fixIEOverlapping:function(){Position.clone("color-picker",this.iefix,{setTop:(!$("color-picker").style.height)});this.iefix.style.zIndex=$("color-picker").getStyle("zIndex")-1;this.iefix.show()},hide:function(){this.removeEvents();$("color-picker").hide();if(this.iefix){this.iefix.hide()}},addEvents:function(){if(this.listeners){return}this.listeners=[["color-picker-close","click",this.hide.bindAsEventListener(this)],["color-picker-sphere","mousedown",this.coreXY.bindAsEventListener(this,"color-picker-cursor")]];if(this.options.draggable){this.listeners.push(["color-picker","mousedown",this.coreXY.bindAsEventListener(this,"color-picker")])}if(this.options.resizable){this.listeners.push(["color-picker-resize","mousedown",this.coreXY.bindAsEventListener(this,"color-picker-resize")])}for(var c=0,b=this.listeners.length;c<b;++c){var a=this.listeners[c];Event.observe(a[0],a[1],a[2])}},removeEvents:function(){if(this.listeners){for(var c=0,b=this.listeners.length;c<b;++c){var a=this.listeners[c];Event.stopObserving(a[0],a[1],a[2])}}this.listeners=null},coords:function(b){var c=b/2,a=(this.hsv[0]/360)*(Math.PI*2),d=(this.hsv[1]+(100-this.hsv[2]))/100*(c/2);$("color-picker-cursor").setStyle({left:Math.round(Math.abs(Math.round(Math.sin(a)*d)+c+3))+"px",top:Math.round(Math.abs(Math.round(Math.cos(a)*d)-c-21))+"px"})},point:function(h,d,c,g,f){this.commit(h,[Event.pointerX(g)+d,Event.pointerY(g)+c],f)},commit:function(a,s,e){if(a=="color-picker-cursor"){var d=parseInt($("color-picker-sphere").getStyle("width")),k=d/2,j=k/2,q=s[0]-k-3,p=d-s[1]-k+21,f=Math.sqrt(Math.pow(q,2)+Math.pow(p,2)),h=Math.atan2(q,p)/(Math.PI*2);this.hsv=[h>0?(h*360):((h*360)+360),f<j?(f/j)*100:100,f>=j?Math.max(0,1-((f-j)/(k-j)))*100:100];var l=Color.hsv2hex(this.hsv);var n=Color.brightness(Color.hsv2rgb(this.hsv));$("color-picker-hex").innerHTML=l;for(var g=0,r=this.options.update.length;g<r;++g){var t=this.options.update[g];switch(t[1]){case"background":$(t[0]).setStyle({backgroundColor:"#"+l},true);$(t[0]).setStyle({color:n<125?"#fff":"#000"},true);break;case"value":$(t[0]).value="#"+l;break}}this.coords(d)}else{if(a=="color-picker-resize"){var m=Math.max(Math.max(s[0],s[1])+e,75);this.coords(m);$("color-picker").setStyle({height:(m+28)+"px",width:(m+20)+"px"});$("color-picker-sphere").setStyle({height:m+"px",width:m+"px"})}else{$(a).setStyle({left:s[0]+"px",top:s[1]+"px"})}}},coreXY:function(f,g){if(!this.stop){return}$("color-picker-cursor").style.visibility="visible";this.stop="";$(g).setStyle({zIndex:this.zIndex++},true);if(g=="color-picker-cursor"){var d=Position.cumulativeOffset($(g).parentNode);this.point(g,-(d[0]-5),-(d[1]-28),f)}var b,a,c;if(g=="color-picker-resize"){b=-(Event.pointerX(f)),a=-(Event.pointerY(f)),c=parseInt($("color-picker-sphere").getStyle("height"))}else{b=parseInt($(g).getStyle("left"))-Event.pointerX(f),a=parseInt($(g).getStyle("top"))-Event.pointerY(f),c=null}document.onmousemove=function(k,l,i,h,j){if(!this.stop){this.point(l,i,h,k,j)}}.bindAsEventListener(this,g,b,a,c);document.onmouseup=function(){this.stop=1;document.onmousemove="";document.onmouseup=""}.bind(this)}};var Color={hsv2hex:function(a){return Color.rgb2hex(Color.hsv2rgb(a))},hex2hsv:function(a){return Color.rgb2hsv(Color.hex2rgb(a))},hex2rgb:function(a){if(a.substring(0,1)=="#"){a=a.substring(1)}return[parseInt(a.substring(0,2),16),parseInt(a.substring(2,4),16),parseInt(a.substring(4,6),16)]},rgb2hex:function(c){var e=c[0].toString(16),d=c[1].toString(16),a=c[2].toString(16);return(e.length==2?e:"0"+e)+(d.length==2?d:"0"+d)+(a.length==2?a:"0"+a)},hsv2rgb:function(a){var j,d,b,g,c,i,f=a[1]/100,e=a[2]/100,h=a[0]/360;if(f>0){if(h>=1){h=0}h=6*h;j=h-Math.floor(h);d=Math.round(255*e*(1-f));c=Math.round(255*e*(1-(f*j)));b=Math.round(255*e*(1-(f*(1-j))));e=Math.round(255*e);switch(Math.floor(h)){case 0:g=e;i=b;c=d;break;case 1:g=c;i=e;c=d;break;case 2:g=d;i=e;c=b;break;case 3:g=d;i=c;c=e;break;case 4:g=b;i=d;c=e;break;case 5:g=e;i=d;c=c;break}return[g?g:0,i?i:0,c?c:0]}else{return[(e=Math.round(e*255)),e,e]}},rgb2hsv:function(a){var f=a[0]/255;var l=a[1]/255;var b=a[2]/255;var h=Math.min(f,l,b);var m=Math.max(f,l,b);var i=m-h;var c=m;var k,e;if(i==0){k=0;e=0}else{e=i/m;var j=(((m-f)/6)+(i/2))/i;var d=(((m-l)/6)+(i/2))/i;var g=(((m-b)/6)+(i/2))/i;if(f==m){k=g-d}else{if(l==m){k=(1/3)+j-g}else{if(b==m){k=(2/3)+d-j}}}if(k<0){k+=1}else{if(k>1){k-=1}}}return[k*100,e*100,c*100]},brightness:function(a){return Math.round((a[0]*299+a[1]*587+a[2]*114)/1000)}};